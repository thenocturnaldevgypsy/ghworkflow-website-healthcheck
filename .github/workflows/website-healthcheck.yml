name: Website Healthcheck and Report

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check websites and generate reports
        run: |
          mkdir -p "Healthcheck Reports"

          WEBSITES=(
            "https://thenocturnaldevgyspy.vercel.app"
            "https://beacons.ai/thenocturnaldevgyspsy"
          )

          TIMESTAMP=$(date -u +"%d%m%Y-%H-%M")
          REPORT_FILE="Healthcheck Reports/report-$TIMESTAMP.md"

          echo "## Last Website Status Check" > README.md
          echo "⏱️ This report is automatically refreshed every 30 minutes." >> README.md

          echo "## Website Health Check Report ($TIMESTAMP UTC)" > $REPORT_FILE

          for WEBSITE in "${WEBSITES[@]}"; do
            STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}" "$WEBSITE")
            CHECKED_AT=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

            if [ "$STATUS_CODE" -eq 200 ]; then
              STATUS="✅ UP"
            else
              STATUS="❌ DOWN (HTTP $STATUS_CODE)"
            fi

            echo "" >> README.md
            echo "Website: $WEBSITE" >> README.md
            echo "- Status: $STATUS" >> README.md
            echo "- Checked at: $CHECKED_AT" >> README.md

            echo "" >> $REPORT_FILE
            echo "Website: $WEBSITE" >> $REPORT_FILE
            echo "- Status: $STATUS" >> $REPORT_FILE
            echo "- Checked at: $CHECKED_AT" >> $REPORT_FILE
          done

      - name: Commit updated reports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md "Healthcheck Reports/report-*.md"
          git commit -m "Update healthcheck report [skip ci]" || echo "No changes to commit"
          git push