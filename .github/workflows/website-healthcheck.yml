name: Website Health Check

on:
  schedule:
    - cron: '*/30 * * * *'  # This will trigger every 30 minutes
  workflow_dispatch:

jobs:
  healthcheck:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Allows pushing changes to the repository

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_TOKEN }}  # Use the PAT stored as a secret for authentication

      - name: Run Website Health Check
        id: check_status
        run: |
          websites=(
            "https://thenocturnaldevgypsy.vercel.app"
            "https://beacons.ai/thenocturnaldevgypsy"
          )
          
          current_time=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
          
          echo "Website status check as of $current_time" > status.txt
          
          for website in "${websites[@]}"; do
            status_code=$(curl --write-out "%{http_code}" --silent --output /dev/null "$website")
            if [ "$status_code" -eq 200 ]; then
              status="✅ UP"
            else
              status="❌ DOWN"
            fi
            echo -e "Website: $website\n- Status: $status\n- Checked at: $current_time\n" >> status.txt
          done

      - name: Update README with Health Status
        run: |
          # Ensure proper expansion of status.txt contents in README
          status_text=$(cat status.txt)
          sed -i "/<!-- GitHub Action will update the section below -->/,/<!-- End of GitHub Action update section -->/c\
          <!-- GitHub Action will update the section below -->\n\
          $status_text\n\
          <!-- End of GitHub Action update section -->" README.md

      - name: Commit updated README
        uses: EndBug/add-and-commit@v7
        with:
          author_name: github-actions[bot]
          author_email: github-actions[bot]@users.noreply.github.com
          message: "Update website health status"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # Provide the token as an environment variable for authentication
